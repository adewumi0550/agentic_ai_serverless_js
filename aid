#!/bin/bash

# Agentic Deployment Integration CLI (Pure Shell Version)
# Uses curl and python3 (standard on macOS/Linux)
# No Node.js or npm required.

set -e

CONFIG_FILE=".env"
GEMINI_MODEL="gemini-1.5-flash"
AID_VERSION="1.0.1"

# --- Queries and Helpers ---

# Helper to escape JSON string using Python
escape_json() {
    python3 -c "import json, sys; print(json.dumps(sys.stdin.read()))"
}

# Helper to extract text from Gemini Response using Python
parse_gemini_response() {
    python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])"
}

# --- Commands ---

# --- Commands ---

# --- Commands ---

cmd_version() {
    echo "aid version $AID_VERSION"
}

cmd_update() {
    echo "üîÑ Checking for updates..."
    
    # 1. Fetch latest version number from GitHub
    latest_version=$(curl -s "https://raw.githubusercontent.com/adewumi0550/agentic_ai_serverless_js/main/aid" | grep '^AID_VERSION=' | cut -d'=' -f2 | tr -d '"')
    
    if [ -z "$latest_version" ]; then
        echo "‚ö†Ô∏è  Could not fetch latest version info."
        # Fallback to force update if check fails? Or just ask user.
        read -p "Force update? [y/N] " force
        if [[ ! "$force" =~ ^[Yy]$ ]]; then exit 0; fi
    else
        if [ "$latest_version" == "$AID_VERSION" ]; then
            echo "‚úÖ You are already on the latest version ($AID_VERSION)."
            exit 0
        fi
        echo "üöÄ New version available: $latest_version (Current: $AID_VERSION)"
    fi

    echo "   Fetching latest installer from GitHub..."
    if curl -fsSL https://raw.githubusercontent.com/adewumi0550/agentic_ai_serverless_js/main/install.sh | bash; then
        echo ""
        echo "‚úÖ Update complete!"
        echo "   New version:"
        "$0" version
    else
        echo "‚ùå Update failed. Please check your internet connection."
        exit 1
    fi
}

# 1. Configuration
cmd_config() {
    if [ -z "$1" ]; then
        echo "üîß Configuration"
        if [ -f "$CONFIG_FILE" ]; then
            cat "$CONFIG_FILE"
        else
            echo "No configuration file found."
        fi
        echo ""
        echo "Usage: ./aid config [key] [value]"
        echo "Example: ./aid config GEMINI_MODEL gemini-1.5-pro"
        return
    fi

    if [ -z "$2" ]; then
        # Get value
        val=$(grep "^$1=" "$CONFIG_FILE" | cut -d'=' -f2)
        echo "$1=$val"
    else
        # Set value
        if grep -q "^$1=" "$CONFIG_FILE"; then
            # Replace existing (BSD sed compliant)
            sed -i '' "s/^$1=.*/$1=\"$2\"/" "$CONFIG_FILE"
        else
            # Append new
            echo "$1=\"$2\"" >> "$CONFIG_FILE"
        fi
        echo "‚úÖ Set $1=\"$2\""
    fi
}

cmd_init() {
    echo "üëã Welcome to Agentic Deployment Integration"
    
    # 1. Setup Gemini Key
    if [ -f "$CONFIG_FILE" ]; then
        load_config
    fi

    if [ -z "$GEMINI_API_KEY" ]; then
        while true; do
            read -sp "Enter your Gemini API Key: " api_key
            echo ""
            
            if [ -z "$api_key" ]; then
                echo "‚ùå API Key cannot be empty."
                continue
            fi

            echo "Testing API Key..."
            # Validating by listing models (more reliable than checking a specific one)
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models?key=$api_key")

            if [ "$response" -eq 200 ]; then
                echo "‚úÖ API Key is valid!"
                break
            else
                echo "‚ùå Invalid API Key (HTTP $response). Please try again."
                echo "   Make sure you copied it correctly from Google AI Studio."
            fi
        done

        echo "GEMINI_API_KEY=\"$api_key\"" >> "$CONFIG_FILE"
        echo "GEMINI_MODEL=\"$GEMINI_MODEL\"" >> "$CONFIG_FILE"
        export GEMINI_API_KEY="$api_key"
        
        echo ""
        echo "‚úÖ Setup Complete! Welcome to:"
        echo ""
        echo "    _    ___ ____  "
        echo "   / \  |_ _|  _ \ "
        echo "  / _ \  | || | | |"
        echo " / ___ \ | || |_| |"
        echo "/_/   \_\___|____/ "
        echo "Agentic Deployment Integration"
        echo "------------------------------"
        echo ""
    else
        echo "‚úÖ Gemini API Key found."
    fi

    # 2. Detect Stack
    echo "üîç Detecting technology stack..."
    stack=""
    if [ -f "Dockerfile" ]; then stack="$stack Docker"; fi
    if [ -f "package.json" ]; then stack="$stack Node.js"; fi
    if [ -f "requirements.txt" ]; then stack="$stack Python"; fi
    if [ -f "go.mod" ]; then stack="$stack Go"; fi
    if [ -f "pubspec.yaml" ]; then stack="$stack Flutter/Dart"; fi
    if [ -f "firebase.json" ]; then stack="$stack Firebase"; fi
    
    if [ -z "$stack" ]; then stack="Unknown/Generic"; fi
    echo "   Detected: $stack"

    # 3. Choose Deployment Platform
    echo ""
    echo "üöÄ Choose your deployment target:"
    echo "1. AWS"
    echo "2. GCP (Google Cloud)"
    echo "3. Vercel"
    echo "4. Render"
    echo "5. DigitalOcean"
    echo "6. Other (Generic)"
    read -p "Select (1-6): " platform_choice

    case "$platform_choice" in
        1)
            platform="AWS"
            read -p "AWS Access Key ID: " aws_key
            read -sp "AWS Secret Access Key: " aws_secret
            echo ""
            echo "AWS_ACCESS_KEY_ID=\"$aws_key\"" >> "$CONFIG_FILE"
            echo "AWS_SECRET_ACCESS_KEY=\"$aws_secret\"" >> "$CONFIG_FILE"
            ;;
        2)
            platform="GCP"
            read -p "GCP Project ID: " gcp_project
            echo "GCP_PROJECT_ID=\"$gcp_project\"" >> "$CONFIG_FILE"
            echo "‚ÑπÔ∏è  Note: Ensure you have 'gcloud' installed and authenticated."
            ;;
        3)
            platform="Vercel"
            read -sp "Vercel Token: " vercel_token
            echo ""
            echo "VERCEL_TOKEN=\"$vercel_token\"" >> "$CONFIG_FILE"
            ;;
        4)
            platform="Render"
            read -sp "Render API Key: " render_key
            echo ""
            echo "RENDER_API_KEY=\"$render_key\"" >> "$CONFIG_FILE"
            ;;
        5)
            platform="DigitalOcean"
            read -sp "DO Personal Access Token: " do_token
            echo ""
            echo "DIGITALOCEAN_TOKEN=\"$do_token\"" >> "$CONFIG_FILE"
            ;;
        *)
            platform="Generic"
            ;;
    esac

    echo "‚úÖ Configuration saved to $CONFIG_FILE"
    echo "DEPLOYMENT_PLATFORM=\"$platform\"" >> "$CONFIG_FILE"

    # 4. Generate Deployment Plan
    echo "üß† Generating deployment plan for $platform ($stack)..."
    
    context=$(scan_codebase)
    prompt="You are a DevOps expert. The user has a $stack project and wants to deploy to $platform.\n\nProject Context:\n$context\n\nGenerate a detailed 'DEPLOYMENT_PLAN.md' that includes:\n1. Prerequisites\n2. Required configuration files (Dockerfile, yaml, etc.) with code snippets.\n3. Step-by-step generic deployment commands.\n4. How to use the keys stored in .env.\n\nOutput ONLY valid Markdown."
    
    call_gemini "$prompt" "DEPLOYMENT_PLAN.md"
}

# 2. Agentic Workflows

cmd_ask() {
    check_config
    if [ -z "$1" ]; then
        echo "‚ùå Usage: ./aid ask \"your question about the codebase\""
        exit 1
    fi
    echo "ü§î Thinking..."
    context=$(scan_codebase)
    prompt="You are an expert developer. Answer this question based on the codebase context provided.\n\nContext:\n$context\n\nQuestion: $1"
    call_gemini "$prompt" "aid_answer.md"
}

cmd_review() {
    check_config
    echo "üßê Reviewing codebase..."
    context=$(scan_codebase)
    prompt="You are a senior staff engineer. Perform a thorough code review of this codebase. Focus on security, performance, and maintainability. Structure your response with a summary followed by file-by-file comments."
    call_gemini "$prompt" "code_review.md" 
}

cmd_refactor() {
    check_config
    if [ -z "$1" ]; then
        echo "‚ùå Usage: ./aid refactor <file_path> \"refactoring instructions\""
        exit 1
    fi
    file="$1"
    instruction="$2"
    
    if [ ! -f "$file" ]; then
        echo "‚ùå File $file not found."
        exit 1
    fi
    
    content=$(cat "$file")
    echo "üîß Refactoring $file..."
    prompt="You are an expert refactorer. Refactor the code in '$file' according to these instructions: '$instruction'. \n\nOriginal Code:\n$content\n\nReturn ONLY the full refactored code block."
    call_gemini "$prompt" "${file}.refactored"
}

cmd_analyze() {
    check_config
    echo "üîç Analyzing project structure and infrastructure..."
    
    # 1. Detect Infrastructure
    infra_context=""
    if [ -f "Dockerfile" ]; then infra_context="$infra_context\n- Dockerfile detected."; fi
    if [ -f "docker-compose.yml" ]; then infra_context="$infra_context\n- Docker Compose detected."; fi
    if [ -f "main.tf" ]; then infra_context="$infra_context\n- Terraform detected."; fi
    if [ -d "k8s" ] || [ -d "kubernetes" ]; then infra_context="$infra_context\n- Kubernetes manifests detected."; fi
    if [ -f "serverless.yml" ]; then infra_context="$infra_context\n- Serverless Framework detected."; fi
    if [ -f "pubspec.yaml" ]; then infra_context="$infra_context\n- Flutter/Dart detected."; fi
    if [ -f "firebase.json" ]; then infra_context="$infra_context\n- Firebase detected."; fi
    
    # 2. Gather File Context
    code_context=$(scan_codebase)
    
    # 3. Build Prompt
    prompt="You are a Principal DevOps Engineer and Software Architect. I need a DEEP DIVE 'Agentic Deployment Integration' report for this workspace.\n\n"
    prompt="${prompt}Infrastructure Context:${infra_context}\n\n"
    prompt="${prompt}Codebase Context:\n${code_context}\n\n"
    prompt="${prompt}Please provide a comprehensive report DETAILED for this specific project type:\n"
    prompt="${prompt}1. **Executive Summary**: Identify if this is a Static Web App, SPA, Serverless Backend, or Containerized Service.\n"
    prompt="${prompt}2. **Stack Analysis**: Language, framework, dependencies.\n"
    prompt="${prompt}   - IF WEB/HTML: Analyze for SEO tags, performance best practices (minification), and responsive design indicators.\n"
    prompt="${prompt}   - IF BACKEND: Analyze for API structure, database connections, and middleware.\n"
    prompt="${prompt}   - IF MOBILE (Flutter): Analyze for state management (BLoC/Provider), widget structure, and asset optimization.\n"
    prompt="${prompt}3. **Architecture & Flow**: \n"
    prompt="${prompt}   - IF WEB: Recommend hosting (Vercel/Netlify/Firebase Hosting) and CDN strategy.\n"
    prompt="${prompt}   - IF BACKEND: Recommend Compute (Cloud Run/Lambda) and Database (SQL/NoSQL).\n"
    prompt="${prompt}   - IF MOBILE: Recommend app store CI/CD (Fastlane), OTA updates, and backend integration (Firebase/Supabase).\n"
    prompt="${prompt}4. **Security Audit**: \n"
    prompt="${prompt}   - IF WEB: Check for XSS risks, CSP headers, exposed keys in client-side code.\n"
    prompt="${prompt}   - IF BACKEND: Check for injection risks, IAM roles, and secret management.\n"
    prompt="${prompt}   - IF MOBILE: Check for insecure storage, API key exposure in binary, and deep link validation.\n"
    prompt="${prompt}5. **Action Plan**: Detailed roadmap to get this specific project to production.\n\n"
    prompt="${prompt}Format the output as a clean, professional Markdown report."

    echo "üß† Generating Agentic Report..."
    call_gemini "$prompt" "AGENTIC_REPORT.md"
}

cmd_docs() {
    check_config
    echo "üìö Generating documentation..."
    context=$(scan_codebase)
    prompt="Generate comprehensive documentation for this project. Include an Overview, Setup Guide, API Reference (if applicable), and Architecture description. Output in Markdown."
    call_gemini "$prompt" "PROJECT_DOCS.md"
}

cmd_report() {
    if [ ! -f "AGENTIC_REPORT.md" ]; then
        echo "‚ö†Ô∏è  No report found. Generating one now..."
        cmd_analyze
    fi
    
    echo "üìÑ Displaying Agentic Report..."
    echo "--------------------------------------------------"
    if command -v mdcat >/dev/null 2>&1; then
        mdcat "AGENTIC_REPORT.md"
    else
        cat "AGENTIC_REPORT.md"
    fi
    echo "--------------------------------------------------"
}

cmd_generate() {
    check_config
    if [ -z "$1" ]; then
        echo "‚ùå Usage: ./aid gen \"Describe the code you want to generate\""
        exit 1
    fi
    echo "üë®‚Äçüíª Generating code..."
    prompt="You are an expert software engineer. Generate high-quality, production-ready code for the following request. Return ONLY the code/markdown.\n\nRequest: $1"
    call_gemini "$prompt" "generated_code.md"
}

# 3. Core & Serverless

cmd_start() {
    echo "üöÄ Starting local server..."
    # Placeholder: Detect project type and run appropriate start command
    if [ -f "package.json" ]; then npm start; 
    elif [ -f "main.py" ]; then python3 main.py;
    else echo "UNKNOWN PROJECT TYPE. Please add a start script."; fi
}

cmd_deploy() {
    check_config
    
    echo "üïµÔ∏è  Agentic Deployment Initiated..."
    echo "---------------------------------"
    
    # 1. Run Analysis First
    echo "üìä Running pre-deployment analysis..."
    cmd_analyze > /dev/null 2>&1
    
    # 2. Extract Key Info from Report (Simple grep for now, or just show the report path)
    echo "‚úÖ Analysis Complete. Report saved to AGENTIC_REPORT.md"
    echo ""
    echo "üìã Deployment Strategy Recommendation:"
    # extract specific lines if possible, or just rely on the user reading the report
    
    stack="Unknown"
    if [ -f "Dockerfile" ]; then stack="Docker Container"; 
    elif [ -f "package.json" ]; then stack="Node.js App";
    elif [ -f "requirements.txt" ]; then stack="Python App"; fi
    
    echo "   Detected Stack: $stack"
    echo "   Recommended Action: Review AGENTIC_REPORT.md for specific architecture advice."
    echo ""
    
    read -p "adding Agentic Deployment Integration... " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "‚ùå Deployment cancelled."
        exit 0
    fi

    echo ""
    echo "üöÄ Proceeding with Deployment Configuration..."
    
    # Now call the original init logic for platform selection if not set
    # Or just proceed with the deployment trigger if config exists
    
    # Check if platform is configured
    if grep -q "DEPLOYMENT_PLATFORM=" "$CONFIG_FILE"; then
        platform=$(grep "DEPLOYMENT_PLATFORM=" "$CONFIG_FILE" | cut -d'=' -f2)
        echo "‚ÑπÔ∏è  Deploying to configured platform: $platform"
        
        # Actual deployment logic (placeholder expansion)
        case "$platform" in
            AWS) echo "üöÄ Executing AWS deployment scripts..." ;;
            GCP) echo "üöÄ Executing gcloud run deploy..." ;;
            Vercel) echo "üöÄ Executing vercel --prod..." ;;
            *) echo "üöÄ Executing generic deployment script..." ;;
        esac
    else
        echo "‚ö†Ô∏è  No deployment platform configured."
        echo "   Redirecting to 'init' to setup deployment target..."
        cmd_init
    fi
}

cmd_push() {
    check_config

    if [ ! -d ".git" ]; then
        echo "‚ùå Not a git repository."
        exit 1
    fi

    echo "üïµÔ∏è  Scanning for changes..."
    # Auto-stage all changes
    git add .
    
    # Check if there are changes to commit
    if git diff --cached --quiet; then
        echo "‚úÖ No changes to commit."
        # Check if there are commits to push
        unpushed=$(git log origin/main..HEAD 2>/dev/null)
        if [ -n "$unpushed" ]; then
             echo "üöÄ Pushing existing commits..."
             git push
             exit 0
        fi
        exit 0
    fi

    echo "üß† Generating semantic commit message..."
    
    # Get diff for context (limit lines to avoid huge payloads)
    diff_content=$(git diff --cached | head -n 50)
    
    prompt="You are a senior developer. Generate a CONCISE, Conventional Commit message (e.g., 'feat: ...', 'fix: ...', 'docs: ...') for this diff. Return ONLY the message string. Do not use quotes.\n\nDiff Context:\n$diff_content"
    
    # Generate message to a temp file
    call_gemini "$prompt" ".commit_msg.tmp" > /dev/null 2>&1
    
    if [ ! -f ".commit_msg.tmp" ]; then
        echo "‚ùå Failed to generate commit message."
        exit 1
    fi
    
    commit_msg=$(cat ".commit_msg.tmp")
    rm ".commit_msg.tmp"
    
    echo ""
    echo "--------------------------------------------------"
    echo "ü§ñ Proposed Commit Message:"
    echo "   $commit_msg"
    echo "--------------------------------------------------"
    echo ""
    
    echo "Do you want to proceed?"
    echo "  (y) Yes, commit and push"
    echo "  (n) No, abort"
    echo "  (e) Edit message manually"
    read -p "Select [y/n/e]: " choice
    
    case "$choice" in
        y|Y)
            echo "üöÄ Committing..."
            git commit -m "$commit_msg"
            echo "‚òÅÔ∏è  Pushing to remote..."
            git push
            echo "‚úÖ Done!"
            ;;
        e|E)
            read -p "Enter your commit message: " custom_msg
            git commit -m "$custom_msg"
            echo "‚òÅÔ∏è  Pushing to remote..."
            git push
            echo "‚úÖ Done!"
            ;;
        *)
            echo "‚ùå Aborted. Changes are staged."
            exit 0
            ;;
    esac
}

# --- Helpers ---

# --- Helpers ---

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        # Read file line by line, skipping comments and empty lines
        while IFS='=' read -r key value || [ -n "$key" ]; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            
            # Remove leading 'export ' if present
            key=${key#export }
            
            # Trim leading/trailing whitespace from key
            key=$(echo "$key" | xargs)
            
            # Remove potentially dangerous characters from key (only allow A-Z0-9_)
            if [[ ! "$key" =~ ^[A-Z0-9_]+$ ]]; then continue; fi

            # Handle value: remove surrounding quotes if present
            # We use a loop or logic to handle values that might contain equals signs
            # Re-assemble value if read split it (read stops at first =)
            # Actually, IFS='=' only splits on the first one if we don't assume more?
            # read -r key value  <-- splits at first delimiter.
            
            # Better approach: parse line string directly to handle 'KEY=VALUE'
            # But the read loop with IFS='=' is standard for simple k=v.
            
            # Let's use a simpler safe approach:
            # 1. Strip leading/trailing quotes from value
            value=${value%\"}
            value=${value#\"}
            value=${value%\'}
            value=${value#\'}
            
            # Expoert safely
            export "$key=$value"
        done < "$CONFIG_FILE"
    fi
}

check_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "‚ùå Run './aid init' first."
        exit 1
    fi
    
    load_config
    
    if [ -z "$GEMINI_API_KEY" ]; then
        echo "‚ùå GEMINI_API_KEY missing."
        exit 1
    fi
    # Use config model or default
    if [ -n "$GEMINI_MODEL" ]; then GEMINI_MODEL="$GEMINI_MODEL"; fi
}

scan_codebase() {
    # Helper to gather context
    find . -maxdepth 2 -type f -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -name 'package-lock.json' -not -name '*.md' | head -n 20 | while read file; do
        if file "$file" | grep -q "text"; then
            echo "--- FILE: $file ---"
            cat "$file"
            echo ""
        fi
    done
}

call_gemini() {
    local prompt="$1"
    local output_file="$2"
    
    # Escape prompt for JSON
    json_payload=$(python3 -c "import json, sys; print(json.dumps({'contents': [{'parts': [{'text': sys.argv[1]}]}]}))" "$prompt")

    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        "https://generativelanguage.googleapis.com/v1beta/models/$GEMINI_MODEL:generateContent?key=$GEMINI_API_KEY" \
        -d "$json_payload")

    if echo "$response" | grep -q "\"error\":"; then
        echo "‚ùå API Error"
        echo "$response"
        exit 1
    fi

    # Extract text
    report=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])")
    
    echo "$report" > "$output_file"
    echo "‚úÖ Output saved to $output_file"
    echo ""
    # Optional: Print preview
    echo "$report" | head -n 10
    echo "... (full output in $output_file)"
}


cmd_help() {
    echo "ü§ñ Agentic Deployment Integration CLI"
    echo "usage: ./aid <command> [args]"
    echo ""
    echo "Core:"
    echo "  init        Setup API Key"
    echo "  config      View or update configuration (e.g., ./aid config GEMINI_MODEL gemini-1.5-pro)"
    echo "  version     Show version info"
    echo "  update      Update aid to the latest version"
    echo "  help        Show this list"
    echo ""
    echo "Agentic AI:"
    echo "  ask         Ask a question about your codebase"
    echo "  analyse     Analyze architecture & quality"
    echo "  review      Perform a comprehensive code review"
    echo "  refactor    Refactor a specific file (./aid refactor file.js \"instructions\")"
    echo "  gen         Generate code from a prompt"
    echo "  docs        Generate project documentation (PROJECT_DOCS.md)"
    echo "  report      View last analysis report"
    echo ""
    echo "Serverless & Ops:"
    echo "  start       Start local server (auto-detects project type)"
    echo "  deploy      Deploy project (runs deploy.sh, sls deploy, etc.)"
    echo "  push        Smart Git Push (Auto-stage, AI Commit Message, Push)"
    echo ""
}

# --- Main Dispatch ---

case "$1" in
    init)       cmd_init ;;
    config)     cmd_config "$2" "$3" ;;
    version|-v|--version) cmd_version ;;
    update|upgrade) cmd_update ;;
    ask)        cmd_ask "$2" ;;
    review)     cmd_review ;;
    refactor)   cmd_refactor "$2" "$3" ;;
    docs)       cmd_docs ;;
    analyse|analyze) cmd_analyze ;; # From previous scan logic (can alias to review or keep separate)
    generate|gen)    cmd_generate "$2" ;;
    report)     cmd_report ;;
    start)      cmd_start ;;
    deploy)     cmd_deploy ;;
    push)       cmd_push ;;
    *)          cmd_help ;;
esac
