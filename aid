#!/bin/bash

# Agentic Deployment Integration CLI (Pure Shell Version)
# Uses curl and python3 (standard on macOS/Linux)
# No Node.js or npm required.

set -e

CONFIG_FILE=".env"
GEMINI_MODEL="gemini-1.5-pro-latest"
AID_VERSION="1.0.2"

# ... (lines 13-308)

    # 4. Build Prompt
    prompt="You are a Principal DevOps Engineer. Analyze this codebase and provide a strategic summary.\n\n"
    prompt="${prompt}Project Config: Language='$proj_lang', Type='$proj_type'\n"
    prompt="${prompt}Infrastructure Context:${infra_context}\n\n"
    prompt="${prompt}Codebase Context:\n${code_context}\n${user_rules}\n"
    prompt="${prompt}Please provide a report with EXACTLY the following sections:\n"
    prompt="${prompt}1. **Product Title**: Name of the project.\n"
    prompt="${prompt}2. **Description**: ~20 lines describing the application's purpose and architecture.\n"
    prompt="${prompt}3. **Recommended Deployment Platform**:\n"
    prompt="${prompt}   - **Services**: Recommended compute (e.g., EC2, Cloud Run, Cloud Functions).\n"
    prompt="${prompt}   - **CDN**: Recommended CDN strategy.\n"
    prompt="${prompt}   - **Deployment Platform**: Specific platform recommendation (e.g., Vercel, Google Cloud).\n\n"
    prompt="${prompt}Keep the report high-level and strategic. Do NOT provide full implementation details or code steps."


    echo "ðŸ§  Generating Agentic Report..."
    call_gemini "$prompt" "aid_reports/deployment_plan.md"
    cp "aid_reports/deployment_plan.md" "AGENTIC_REPORT.md" # Keep legacy link for now
    log_history "analyze"
}

cmd_docs() {
    check_config
    echo "ðŸ“š Generating documentation..."
    context=$(scan_codebase)
    prompt="Generate comprehensive documentation for this project. Include an Overview, Setup Guide, API Reference (if applicable), and Architecture description. Output in Markdown."
    call_gemini "$prompt" "PROJECT_DOCS.md"
    log_history "docs"
}

cmd_report() {
    if [ ! -f "AGENTIC_REPORT.md" ]; then
        echo "âš ï¸  No report found. Generating one now..."
        cmd_analyze
    fi
    
    echo "ðŸ“„ Displaying Agentic Report..."
    echo "--------------------------------------------------"
    if command -v mdcat >/dev/null 2>&1; then
        mdcat "AGENTIC_REPORT.md"
    else
        cat "AGENTIC_REPORT.md"
    fi
    echo "--------------------------------------------------"
}

cmd_generate() {
    check_config
    if [ -z "$1" ]; then
        echo "âŒ Usage: ./aid gen \"Describe the code you want to generate\""
        exit 1
    fi
    echo "ðŸ‘¨â€ðŸ’» Generating code..."
    prompt="You are an expert software engineer. Generate high-quality, production-ready code for the following request. Return ONLY the code/markdown.\n\nRequest: $1"
    call_gemini "$prompt" "generated_code.md"
    log_history "gen"
}

cmd_history() {
    if [ -f ".aid/history.log" ]; then
        echo "ðŸ“œ Developer History:"
        cat ".aid/history.log"
    else
        echo "No history yet."
    fi
}

# 3. Core & Serverless

cmd_start() {
    echo "ðŸš€ Starting local server..."
    # Placeholder: Detect project type and run appropriate start command
    if [ -f "package.json" ]; then npm start; 
    elif [ -f "main.py" ]; then python3 main.py;
    elif [ -f "composer.json" ]; then php -S localhost:8000;
    elif [ -f "index.html" ]; then python3 -m http.server;
    else echo "UNKNOWN PROJECT TYPE. Please add a start script."; fi
}

cmd_deploy() {
    check_config
    
    echo "ðŸ•µï¸  Agentic Deployment Initiated..."
    echo "---------------------------------"
    
    # 1. Check/Set Deployment Platform
    if [ -z "$DEPLOYMENT_PLATFORM" ]; then
        echo "ðŸš€ Choose your deployment target:"
        echo "1. AWS"
        echo "2. GCP (Google Cloud)"
        echo "3. Vercel"
        echo "4. Render"
        echo "5. DigitalOcean"
        echo "6. Other (Generic)"
        read -p "Select (1-6): " platform_choice

        case "$platform_choice" in
            1)
                platform="AWS"
                read -p "AWS Access Key ID: " aws_key
                read -sp "AWS Secret Access Key: " aws_secret
                echo ""
                if [ -f "$CONFIG_FILE" ]; then
                    echo "AWS_ACCESS_KEY_ID=\"$aws_key\"" >> "$CONFIG_FILE"
                    echo "AWS_SECRET_ACCESS_KEY=\"$aws_secret\"" >> "$CONFIG_FILE"
                fi
                ;;
            2)
                platform="GCP"
                read -p "GCP Project ID: " gcp_project
                if [ -f "$CONFIG_FILE" ]; then
                     echo "GCP_PROJECT_ID=\"$gcp_project\"" >> "$CONFIG_FILE"
                fi
                echo "â„¹ï¸  Note: Ensure you have 'gcloud' installed and authenticated."
                ;;
            3)
                platform="Vercel"
                read -sp "Vercel Token: " vercel_token
                echo ""
                if [ -f "$CONFIG_FILE" ]; then
                    echo "VERCEL_TOKEN=\"$vercel_token\"" >> "$CONFIG_FILE"
                fi
                ;;
            4)
                platform="Render"
                read -sp "Render API Key: " render_key
                echo ""
                if [ -f "$CONFIG_FILE" ]; then
                    echo "RENDER_API_KEY=\"$render_key\"" >> "$CONFIG_FILE"
                fi
                ;;
            5)
                platform="DigitalOcean"
                read -sp "DO Personal Access Token: " do_token
                echo ""
                if [ -f "$CONFIG_FILE" ]; then
                    echo "DIGITALOCEAN_TOKEN=\"$do_token\"" >> "$CONFIG_FILE"
                fi
                ;;
            *)
                platform="Generic"
                ;;
        esac
        
        echo "DEPLOYMENT_PLATFORM=\"$platform\"" >> "$CONFIG_FILE"
        export DEPLOYMENT_PLATFORM="$platform"
        echo "âœ… Platform configured: $platform"
    else
        echo "âœ… Platform already configured: $DEPLOYMENT_PLATFORM"
        platform="$DEPLOYMENT_PLATFORM"
    fi

    # 4. Generate Deployment Plan (if not exists or forced)
    echo -e "${CYAN}ðŸ§  Generating deployment plan for $platform...${NC}"
    
    stack="${PROJECT_LANGUAGE:-Auto-Detect}"
    ptype="${PROJECT_TYPE:-Auto-Detect}"
    
    context=$(scan_codebase)
    prompt="You are a Principal DevOps Engineer. The user has a **$stack** project (Type: **$ptype**) and wants to deploy to **$platform**.\n\n"
    prompt="${prompt}**Project Context**:\n$context\n\n"
    prompt="${prompt}Generate a detailed **DEPLOYMENT_PLAN.md** structured as follows:\n"
    prompt="${prompt}### 1. ðŸ—ï¸ Architecture & Prerequisites\n"
    prompt="${prompt}- Necessary tools (CLI, accounts).\n"
    prompt="${prompt}- Expected costs/limits for $platform.\n"
    prompt="${prompt}### 2. âš™ï¸ Configuration\n"
    prompt="${prompt}- Create/Update these files (Dockerfile, serverless.yml, etc.). provide FULL CODE content.\n"
    prompt="${prompt}### 3. ðŸš€ Deployment Steps\n"
    prompt="${prompt}- Step-by-step shell commands to deploy.\n"
    prompt="${prompt}- How to inject environment variables (referencing local .env keys).\n"
    prompt="${prompt}### 4. ðŸ” Verification\n"
    prompt="${prompt}- How to check logs and health.\n\n"
    prompt="${prompt}Output ONLY valid Markdown. Use specific icons and headers to make it look professional."
    
    call_gemini "$prompt" "aid_reports/DEPLOYMENT_PLAN.md"
    cp "aid_reports/DEPLOYMENT_PLAN.md" "DEPLOYMENT_PLAN.md"

    echo -e "${GREEN}âœ… Plan Generated: DEPLOYMENT_PLAN.md${NC}"
    read -p "View plan now? [Y/n] " view_plan
    if [[ ! "$view_plan" =~ ^[Nn]$ ]]; then
        if command -v mdcat >/dev/null 2>&1; then mdcat "DEPLOYMENT_PLAN.md"; else cat "DEPLOYMENT_PLAN.md"; fi
    fi

    echo ""
    read -p "Proceed with automated deployment steps? [y/N] " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}âŒ Deployment execution cancelled. Follow the manual plan above.${NC}"
        exit 0
    fi
    
    echo -e "${BLUE}ðŸš€ Executing deployment basics...${NC}"
    case "$platform" in
        AWS) echo "aws s3 sync . s3://bucket --dryrun" ;;
        GCP) echo "gcloud run deploy --source ." ;;
        Vercel) echo "vercel --prod" ;;
        *) echo "Generic deployment script" ;;
    esac
    log_history "deploy"
}

cmd_push() {
    check_config
    
    # Ensure ignores before adding
    ensure_gitignore
    
    # Safety: Remove cached ignored files if they were accidentally added
    IGNORED_ITEMS=("node_modules" "dist" "build" ".env" ".DS_Store" ".aid" "aid_reports" "yarn-cache" "coverage")
    for item in "${IGNORED_ITEMS[@]}"; do
        if git ls-files --error-unmatch "$item" >/dev/null 2>&1; then
             echo -e "${YELLOW}ðŸ§¹ Removing $item from git index...${NC}"
             git rm -r --cached "$item" >/dev/null 2>&1
        fi
    done

    if [ ! -d ".git" ]; then
        echo "âŒ Not a git repository."
        exit 1
    fi

    echo "ðŸ•µï¸  Scanning for changes..."
    # Auto-stage all changes
    git add .
    
    # Check if there are changes to commit
    if git diff --cached --quiet; then
        echo "âœ… No changes to commit."
        # Check if there are commits to push
        unpushed=$(git log origin/main..HEAD 2>/dev/null)
        if [ -n "$unpushed" ]; then
             echo "ðŸš€ Pushing existing commits..."
             git push
             exit 0
        fi
        exit 0
    fi

    echo "ðŸ§  Generating semantic commit message..."
    
    # Get diff for context (limit lines to avoid huge payloads)
    diff_content=$(git diff --cached | head -n 50)
    
    prompt="You are a senior developer. Generate a CONCISE, Conventional Commit message (e.g., 'feat: ...', 'fix: ...', 'docs: ...') for this diff. Return ONLY the message string. Do not use quotes.\n\nDiff Context:\n$diff_content"
    
    # Generate message to a temp file
    call_gemini "$prompt" ".commit_msg.tmp" > /dev/null 2>&1
    
    if [ ! -f ".commit_msg.tmp" ]; then
        echo "âŒ Failed to generate commit message."
        exit 1
    fi
    
    commit_msg=$(cat ".commit_msg.tmp")
    rm ".commit_msg.tmp"
    
    echo ""
    echo "--------------------------------------------------"
    echo "ðŸ¤– Proposed Commit Message:"
    echo "   $commit_msg"
    echo "--------------------------------------------------"
    echo ""
    
    echo "Do you want to proceed?"
    echo "  (y) Yes, commit and push"
    echo "  (n) No, abort"
    echo "  (e) Edit message manually"
    read -p "Select [y/n/e]: " choice
    
    case "$choice" in
        y|Y)
            echo "ðŸš€ Committing..."
            git commit -m "$commit_msg"
            echo "â˜ï¸  Pushing to remote..."
            git push
            echo "âœ… Done!"
            ;;
        e|E)
            read -p "Enter your commit message: " custom_msg
            git commit -m "$custom_msg"
            echo "â˜ï¸  Pushing to remote..."
            git push
            echo "âœ… Done!"
            ;;
        *)
            echo "âŒ Aborted. Changes are staged."
            exit 0
            ;;
    esac
    log_history "push"
}

# --- Helpers ---

# --- Helpers ---

log_history() {
    local cmd="$1"
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    mkdir -p ".aid"
    echo "[$timestamp] $cmd" >> ".aid/history.log"
}

source_config() {
    local file="$1"
    if [ -f "$file" ]; then
        # Read file line by line
        while IFS='=' read -r key value || [ -n "$key" ]; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            
            # Remove leading 'export '
            key=${key#export }
            
            # Trim whitespace
            key=$(echo "$key" | xargs)
            
            # Validate key
            if [[ ! "$key" =~ ^[A-Z0-9_]+$ ]]; then continue; fi

            # Clean value
            value=${value%\"}
            value=${value#\"}
            value=${value%\'}
            value=${value#\'}
            
            # Export
            export "$key=$value"
        done < "$file"
    fi
}

load_config() {
    GLOBAL_CONFIG_FILE="$HOME/.aid/config"
    # Load Global first
    source_config "$GLOBAL_CONFIG_FILE"
    
    # Load Local Secure (.aid/config) - PRIMARY
    if [ -f ".aid/config" ]; then
        source_config ".aid/config"
        CONFIG_FILE=".aid/config" # Update current active config
    # Backwards compatibility / Override
    elif [ -f ".env" ]; then
        source_config ".env"
        CONFIG_FILE=".env"
    fi
}

check_config() {
    config_found=0
    if [ -f ".aid/config" ]; then config_found=1; fi
    if [ -f ".env" ]; then config_found=1; fi
    if [ -f "$HOME/.aid/config" ]; then config_found=1; fi

    if [ "$config_found" -eq 0 ]; then
        echo -e "${RED}âŒ No configuration found.${NC}" 
        echo "   Run './aid init' to setup your project."
        exit 1
    fi
    
    load_config
    
    if [ -z "$GEMINI_API_KEY" ]; then
        echo -e "${RED}âŒ GEMINI_API_KEY missing.${NC}"
        exit 1
    fi
    # Use config model or default
    if [ -n "$GEMINI_MODEL" ]; then GEMINI_MODEL="$GEMINI_MODEL"; fi
}

scan_codebase() {
    # Helper to gather context
    find . -maxdepth 2 -type f -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -name 'package-lock.json' -not -name '*.md' | head -n 20 | while read file; do
        if file "$file" | grep -q "text"; then
            echo "--- FILE: $file ---"
            cat "$file"
            echo ""
        fi
    done
}

call_gemini() {
    local prompt="$1"
    local output_file="$2"
    
    # Escape prompt for JSON
    json_payload=$(python3 -c "import json, sys; print(json.dumps({'contents': [{'parts': [{'text': sys.argv[1]}]}]}))" "$prompt")

    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        "https://generativelanguage.googleapis.com/v1beta/models/$GEMINI_MODEL:generateContent?key=$GEMINI_API_KEY" \
        -d "$json_payload")

    if echo "$response" | grep -q "\"error\":"; then
        echo "âŒ API Error"
        # Check for 404 (Model Not Found)
        if echo "$response" | grep -q '"code": 404'; then
             echo "â„¹ï¸  The model '$GEMINI_MODEL' was not found or is not supported."
             echo "ðŸ” Fetching available models for your key..."
             models_response=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models?key=$GEMINI_API_KEY")
             if echo "$models_response" | grep -q "\"models\":"; then
                 echo "âœ… Available Models:"
                 echo "$models_response" | python3 -c "import sys, json; print('\n'.join([m['name'].replace('models/', '') for m in json.load(sys.stdin)['models']]))"
                 echo ""
                 echo "ðŸ‘‰ To use one of these, run: ./aid config GEMINI_MODEL <model_name>"
             else
                 echo "âŒ Could not list models."
             fi
        else
            echo "$response"
        fi
        exit 1
    fi

    # Extract text
    report=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])")
    
    echo "$report" > "$output_file"
    echo "âœ… Output saved to $output_file"
    echo ""
    # Optional: Print preview
    echo "$report" | head -n 10
    echo "... (full output in $output_file)"
}


cmd_help() {
    echo "ðŸ¤– Agentic Deployment Integration CLI"
    echo "usage: ./aid <command> [args]"
    echo ""
    echo "Core:"
    echo "  init        Setup API Key"
    echo "  config      View or update configuration (e.g., ./aid config GEMINI_MODEL gemini-1.5-pro)"
    echo "  version     Show version info"
    echo "  update      Update aid to the latest version"
    echo "  update      Update aid to the latest version"
    echo "  history     View command history"
    echo "  clean       Clear the terminal screen"
    echo "  help        Show this list"
    echo ""
    echo "Agentic AI:"
    echo "  ask         Ask a question about your codebase"
    echo "  analyse     Analyze architecture & quality"
    echo "  review      Perform a comprehensive code review"
    echo "  refactor    Refactor a specific file (./aid refactor file.js \"instructions\")"
    echo "  gen         Generate code from a prompt"
    echo "  docs        Generate project documentation (PROJECT_DOCS.md)"
    echo "  report      View last analysis report"
    echo ""
    echo "Serverless & Ops:"
    echo "  start       Start local server (auto-detects project type)"
    echo "  deploy      Deploy project (runs deploy.sh, sls deploy, etc.)"
    echo "  push        Smart Git Push (Auto-stage, AI Commit Message, Push)"
    echo "  push        Smart Git Push (Auto-stage, AI Commit Message, Push)"
    echo ""
}

cmd_clean() {
    clear
    echo -e "${GREEN}âœ¨ Screen cleaned!${NC}"
    cmd_help
}

# --- Main Dispatch ---

case "$1" in
    init)       cmd_init ;;
    config)     cmd_config "$2" "$3" ;;
    version|-v|--version) cmd_version ;;
    update|upgrade) cmd_update ;;
    history)    cmd_history ;;
    ask)        cmd_ask "$2" ;;
    review)     cmd_review ;;
    refactor)   cmd_refactor "$2" "$3" ;;
    docs)       cmd_docs ;;
    analyse|analyze) cmd_analyze ;; # From previous scan logic (can alias to review or keep separate)
    generate|gen)    cmd_generate "$2" ;;
    report)     cmd_report ;;
    start)      cmd_start ;;
    deploy)     cmd_deploy ;;
    deploy)     cmd_deploy ;;
    push)       cmd_push ;;
    clean)      cmd_clean ;;
    *)          cmd_help ;;
esac
