#!/bin/bash

# Agentic AI Serverless CLI (Pure Shell Version)
# Uses curl and python3 (standard on macOS/Linux)
# No Node.js or npm required.

set -e

CONFIG_FILE=".env"
GEMINI_MODEL="gemini-1.5-flash"

# --- Queries and Helpers ---

# Helper to escape JSON string using Python
escape_json() {
    python3 -c "import json, sys; print(json.dumps(sys.stdin.read()))"
}

# Helper to extract text from Gemini Response using Python
parse_gemini_response() {
    python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])"
}

# --- Commands ---

# --- Commands ---

cmd_init() {
    echo "ðŸ‘‹ Welcome to Agentic AI Serverless (Shell Edition)"
    echo "This tool connects to Google Gemini API directly."
    echo ""
    read -sp "Enter your Gemini API Key: " api_key
    echo ""
    
    if [ -z "$api_key" ]; then
        echo "âŒ API Key cannot be empty."
        exit 1
    fi

    echo "GEMINI_API_KEY=$api_key" > "$CONFIG_FILE"
    echo "âœ… Configuration saved to $CONFIG_FILE"
}

cmd_start() {
    echo "ðŸš€ Starting Agentic AI process..."
    count=$(find . -maxdepth 1 -type f | wc -l)
    echo "â„¹ï¸  Reading files in current directory... ($count files detected)"
    echo "Placeholder: Start logic would go here."
}

check_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "âŒ No configuration found. Please run './ais init' first."
        exit 1
    fi
    # Source the .env file
    export $(grep -v '^#' "$CONFIG_FILE" | xargs)
    if [ -z "$GEMINI_API_KEY" ]; then
        echo "âŒ GEMINI_API_KEY not found in $CONFIG_FILE"
        exit 1
    fi
}

cmd_analyze() {
    check_config
    echo "ðŸ” Scanning files..."
    
    # Collect file contents (skipping hidden, node_modules, git, binaries)
    context=""
    file_list=$(find . -maxdepth 2 -type f -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -name 'package-lock.json' -not -name 'analysis_report.md' | head -n 20)
    
    for file in $file_list; do
        if file "$file" | grep -q "text"; then
            content=$(cat "$file")
            context+=$'\n'"--- FILE: $file ---"$'\n'"$content"$'\n'
        fi
    done

    if [ -z "$context" ]; then
        echo "âš ï¸  No text files found to analyze."
        exit 0
    fi

    echo "ðŸ§  Analyzing codebase with Gemini ($GEMINI_MODEL)..."
    prompt="You are an expert software engineer. Analyze the following codebase and provide a comprehensive report.\n\nCodebase Context:\n$context\n\nReport Structure:\n1. **Project Overview**\n2. **Architecture**\n3. **Code Quality**\n4. **Improvement Suggestions**"

    call_gemini "$prompt" "analysis_report.md"
}

cmd_generate() {
    check_config
    if [ -z "$1" ]; then
        echo "âŒ Usage: ./ais generate \"your requirements here\""
        exit 1
    fi
    
    prompt="You are an expert coder. Generate code for the following requirement:\n\nRequest: $1\n\nProvide the code clearly within markdown code blocks."
    
    echo "ðŸ§  Generating code with Gemini..."
    call_gemini "$prompt" "generated_code.md"
}

cmd_report() {
    if [ -f "analysis_report.md" ]; then
        echo "ðŸ“„ Opening Analysis Report..."
        if command -v more &> /dev/null; then
            more analysis_report.md
        else
            cat analysis_report.md
        fi
    else
        echo "âŒ No report found. Run './ais analyse' first."
    fi
}

cmd_deploy() {
    echo "ðŸš€ Deploying project..."
    # Placeholder for deployment logic (e.g., gcloud run deploy, serverless deploy)
    if [ -f "deploy.sh" ]; then
        ./deploy.sh
    else
        echo "âš ï¸  No 'deploy.sh' found. Please create a deployment script or configure your provider."
        echo "Simulating deployment... Done!"
    fi
}

call_gemini() {
    local prompt="$1"
    local output_file="$2"

    json_payload=$(python3 -c "import json, sys; print(json.dumps({'contents': [{'parts': [{'text': sys.argv[1]}]}]}))" "$prompt")

    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        "https://generativelanguage.googleapis.com/v1beta/models/$GEMINI_MODEL:generateContent?key=$GEMINI_API_KEY" \
        -d "$json_payload")

    if echo "$response" | grep -q "\"error\":"; then
        echo "âŒ API Request Failed:"
        echo "$response"
        exit 1
    fi

    report=$(echo "$response" | parse_gemini_response)
    
    echo ""
    echo "--- Output ---"
    echo "$report"
    echo ""
    
    echo "$report" > "$output_file"
    echo "âœ… Output saved to $output_file"
}

cmd_help() {
    echo "Agentic AI Serverless CLI (Bash)"
    echo "Usage: ./ais [command]"
    echo ""
    echo "Commands:"
    echo "  init             Setup or change API Key"
    echo "  analyse          Analyze current directory & generate report"
    echo "  generate [req]   Generate code based on requirements"
    echo "  report           View the last analysis report"
    echo "  deploy           Deploy the project (runs deploy.sh)"
    echo "  start            Start process (placeholder)"
    echo "  help             Show this help"
}

# --- Main Dispatch ---

case "$1" in
    init|config)
        cmd_init
        ;;
    start)
        cmd_start
        ;;
    analyse|analyze)
        cmd_analyze
        ;;
    generate|gen)
        cmd_generate "$2"
        ;;
    report|view)
        cmd_report
        ;;
    deploy)
        cmd_deploy
        ;;
    *)
        cmd_help
        ;;
esac
