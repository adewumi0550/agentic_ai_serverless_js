#!/bin/bash

# Agentic AI Serverless CLI (Pure Shell Version)
# Uses curl and python3 (standard on macOS/Linux)
# No Node.js or npm required.

set -e

CONFIG_FILE=".env"
GEMINI_MODEL="gemini-1.5-flash"

# --- Queries and Helpers ---

# Helper to escape JSON string using Python
escape_json() {
    python3 -c "import json, sys; print(json.dumps(sys.stdin.read()))"
}

# Helper to extract text from Gemini Response using Python
parse_gemini_response() {
    python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])"
}

# --- Commands ---

# --- Commands ---

# 1. Configuration
cmd_config() {
    if [ -z "$1" ]; then
        echo "üîß Configuration"
        if [ -f "$CONFIG_FILE" ]; then
            cat "$CONFIG_FILE"
        else
            echo "No configuration file found."
        fi
        echo ""
        echo "Usage: ./ais config [key] [value]"
        echo "Example: ./ais config GEMINI_MODEL gemini-1.5-pro"
        return
    fi

    if [ -z "$2" ]; then
        # Get value
        val=$(grep "^$1=" "$CONFIG_FILE" | cut -d'=' -f2)
        echo "$1=$val"
    else
        # Set value
        if grep -q "^$1=" "$CONFIG_FILE"; then
            # Replace existing (BSD sed compliant)
            sed -i '' "s/^$1=.*/$1=$2/" "$CONFIG_FILE"
        else
            # Append new
            echo "$1=$2" >> "$CONFIG_FILE"
        fi
        echo "‚úÖ Set $1=$2"
    fi
}

cmd_init() {
    echo "üëã Welcome to Agentic AI Serverless"
    read -sp "Enter your Gemini API Key: " api_key
    echo ""
    if [ -z "$api_key" ]; then
        echo "‚ùå API Key cannot be empty."
        exit 1
    fi
    echo "GEMINI_API_KEY=$api_key" > "$CONFIG_FILE"
    echo "GEMINI_MODEL=$GEMINI_MODEL" >> "$CONFIG_FILE"
    echo "‚úÖ Configuration saved to $CONFIG_FILE"
}

# 2. Agentic Workflows

cmd_ask() {
    check_config
    if [ -z "$1" ]; then
        echo "‚ùå Usage: ./ais ask \"your question about the codebase\""
        exit 1
    fi
    echo "ü§î Thinking..."
    context=$(scan_codebase)
    prompt="You are an expert developer. Answer this question based on the codebase context provided.\n\nContext:\n$context\n\nQuestion: $1"
    call_gemini "$prompt" "ais_answer.md"
}

cmd_review() {
    check_config
    echo "üßê Reviewing codebase..."
    context=$(scan_codebase)
    prompt="You are a senior staff engineer. Perform a thorough code review of this codebase. Focus on security, performance, and maintainability. Structure your response with a summary followed by file-by-file comments."
    call_gemini "$prompt" "code_review.md" 
}

cmd_refactor() {
    check_config
    if [ -z "$1" ]; then
        echo "‚ùå Usage: ./ais refactor <file_path> \"refactoring instructions\""
        exit 1
    fi
    file="$1"
    instruction="$2"
    
    if [ ! -f "$file" ]; then
        echo "‚ùå File $file not found."
        exit 1
    fi
    
    content=$(cat "$file")
    echo "üîß Refactoring $file..."
    prompt="You are an expert refactorer. Refactor the code in '$file' according to these instructions: '$instruction'. \n\nOriginal Code:\n$content\n\nReturn ONLY the full refactored code block."
    call_gemini "$prompt" "${file}.refactored"
}

cmd_docs() {
    check_config
    echo "üìö Generating documentation..."
    context=$(scan_codebase)
    prompt="Generate comprehensive documentation for this project. Include an Overview, Setup Guide, API Reference (if applicable), and Architecture description. Output in Markdown."
    call_gemini "$prompt" "PROJECT_DOCS.md"
}

# 3. Core & Serverless

cmd_start() {
    echo "üöÄ Starting local server..."
    # Placeholder: Detect project type and run appropriate start command
    if [ -f "package.json" ]; then npm start; 
    elif [ -f "main.py" ]; then python3 main.py;
    else echo "UNKNOWN PROJECT TYPE. Please add a start script."; fi
}

cmd_deploy() {
    echo "‚òÅÔ∏è  Deploying..."
    # Placeholder: looking for common deployment scripts
    if [ -f "deploy.sh" ]; then ./deploy.sh;
    elif [ -f "serverless.yml" ]; then sls deploy;
    elif [ -f "gcloud" ]; then gcloud run deploy;
    else echo "‚ö†Ô∏è  No deployment config found (deploy.sh, serverless.yml)."; fi
}

# --- Helpers ---

check_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "‚ùå Run './ais init' first."
        exit 1
    fi
    export $(grep -v '^#' "$CONFIG_FILE" | xargs)
    if [ -z "$GEMINI_API_KEY" ]; then
        echo "‚ùå GEMINI_API_KEY missing."
        exit 1
    fi
    # Use config model or default
    if [ -n "$GEMINI_MODEL" ]; then GEMINI_MODEL="$GEMINI_MODEL"; fi
}

scan_codebase() {
    # Helper to gather context
    find . -maxdepth 2 -type f -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -name 'package-lock.json' -not -name '*.md' | head -n 20 | while read file; do
        if file "$file" | grep -q "text"; then
            echo "--- FILE: $file ---"
            cat "$file"
            echo ""
        fi
    done
}

call_gemini() {
    local prompt="$1"
    local output_file="$2"
    
    # Escape prompt for JSON
    json_payload=$(python3 -c "import json, sys; print(json.dumps({'contents': [{'parts': [{'text': sys.argv[1]}]}]}))" "$prompt")

    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        "https://generativelanguage.googleapis.com/v1beta/models/$GEMINI_MODEL:generateContent?key=$GEMINI_API_KEY" \
        -d "$json_payload")

    if echo "$response" | grep -q "\"error\":"; then
        echo "‚ùå API Error"
        echo "$response"
        exit 1
    fi

    # Extract text
    report=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])")
    
    echo "$report" > "$output_file"
    echo "‚úÖ Output saved to $output_file"
    echo ""
    # Optional: Print preview
    echo "$report" | head -n 10
    echo "... (full output in $output_file)"
}


cmd_help() {
    echo "ü§ñ Agentic AI Serverless CLI"
    echo "usage: ./ais <command> [args]"
    echo ""
    echo "Core:"
    echo "  init        Setup API Key"
    echo "  config      View or update configuration (e.g., ./ais config GEMINI_MODEL gemini-1.5-pro)"
    echo "  help        Show this list"
    echo ""
    echo "Agentic AI:"
    echo "  ask         Ask a question about your codebase"
    echo "  analyse     Analyze architecture & quality"
    echo "  review      Perform a comprehensive code review"
    echo "  refactor    Refactor a specific file (./ais refactor file.js \"instructions\")"
    echo "  gen         Generate code from a prompt"
    echo "  docs        Generate project documentation (PROJECT_DOCS.md)"
    echo "  report      View last analysis report"
    echo ""
    echo "Serverless & Ops:"
    echo "  start       Start local server (auto-detects project type)"
    echo "  deploy      Deploy project (runs deploy.sh, sls deploy, etc.)"
    echo ""
}

# --- Main Dispatch ---

case "$1" in
    init)       cmd_init ;;
    config)     cmd_config "$2" "$3" ;;
    ask)        cmd_ask "$2" ;;
    review)     cmd_review ;;
    refactor)   cmd_refactor "$2" "$3" ;;
    docs)       cmd_docs ;;
    analyse|analyze) cmd_analyze ;; # From previous scan logic (can alias to review or keep separate)
    generate|gen)    cmd_generate "$2" ;;
    report)     cmd_report ;;
    start)      cmd_start ;;
    deploy)     cmd_deploy ;;
    *)          cmd_help ;;
esac
